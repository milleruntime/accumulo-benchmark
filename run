#!/bin/bash
JMH_CMD="java -jar target/benchmarks.jar "
OUT_FILE="results-`date +%F_%H%M%S`"

usage() {
  echo "$0 [-g|--generate] [-i|--iter <num>] [-p|--print] [-t|--test <test>]"
  echo "Options:"
  echo "-t|--test <test>    Test to run in JMH"
  echo "-g|--generate    Generate RFile for testing"
  echo "-i|--iter <num>    Set the number of test iterations"
  echo "-p|--print     Print all of the available tests"
  exit
}

if [[ -z "$@" ]]; then
  usage
fi

while [[ $# -gt 0 ]]
do
case $1 in
    -g|--generate)
    GENERATE=YES
    ;;
    -p|--print)
    PRINT_TESTS=YES
    ;;
    -i|--iter)
    ITERATIONS="$2"
    shift 
    ;;
    -t|--test)
    TEST=$2 
    shift
    ;;
    *)
    echo "Unknown option: $1"
    ;;
esac
shift
done

if [[ -n "$PRINT_TESTS" ]]; then
  java -cp target/benchmarks.jar org.sample.PrintTests
  exit 0
fi
if [[ -n "$GENERATE" ]]; then
  java -cp target/benchmarks.jar org.sample.Generate
  exit 0
fi

if [[ -n $TEST ]]; then
  if [[ ! -d "./results" ]]; then
     mkdir ./results
  fi
  uname -rsv > results/$OUT_FILE
  if [[ -n "$ITERATIONS" ]]; then
     $JMH_CMD -f 1 -i "$ITERATIONS" "$TEST" | tee -a ./results/$OUT_FILE
     GOOD=YES
  else
     $JMH_CMD -f 1 "$TEST" | tee -a ./results/$OUT_FILE
     GOOD=YES
  fi
fi

if [[ -z "$GOOD" ]]; then
  usage
fi
